(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();class x{constructor(e){this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clear(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawCircle(e,s,t,i){this.ctx.beginPath(),this.ctx.arc(e,s,t,0,Math.PI*2),this.ctx.fillStyle=i,this.ctx.fill(),this.ctx.closePath()}drawRect(e,s,t,i,n){this.ctx.fillStyle=n,this.ctx.fillRect(e-t/2,s-i/2,t,i)}drawText(e,s,t,i="white",n=20){this.ctx.fillStyle=i,this.ctx.font=`${n}px Inter, sans-serif`,this.ctx.fillText(e,s,t)}}class f{constructor(e,s,t,i,n){this.x=e,this.y=s,this.size=t,this.color=i,this.speed=n,this.isDead=!1}update(e){}draw(e){}}class v extends f{constructor(e,s,t,i,n){super(e,s,n.size,"#f1c40f",n.speed);const r=t-e,a=i-s,h=Math.sqrt(r*r+a*a);this.vx=r/h*this.speed,this.vy=a/h*this.speed,this.lifeTime=n.range/n.speed,this.damage=n.damage,this.pierce=n.pierce,this.hitEnemies=[]}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.lifeTime-=e,this.lifeTime<=0&&(this.isDead=!0)}draw(e){e.drawCircle(this.x,this.y,this.size,this.color)}}class E extends f{constructor(e,s,t){super(e,s,8,"#2ecc71",0),this.value=t}update(e){}draw(e){e.drawRect(this.x,this.y,this.size,this.size,this.color)}}class w extends f{constructor(e,s){super(e,s,15,"#3498db",200),this.hp=100,this.maxHp=100,this.level=1,this.exp=0,this.nextLevelExp=100,this.points=0,this.moveSpeed=200,this.magnet=100,this.pStats={size:5,speed:400,damage:10,count:1,pierce:0,cooldown:.5,range:300,detection:400,spread:.2},this.attackTimer=0}update(e,s,t,i){let n=0,r=0;if((s.keys.ArrowUp||s.keys.w)&&(r-=1),(s.keys.ArrowDown||s.keys.s)&&(r+=1),(s.keys.ArrowLeft||s.keys.a)&&(n-=1),(s.keys.ArrowRight||s.keys.d)&&(n+=1),n!==0||r!==0){const a=Math.sqrt(n*n+r*r);n/=a,r/=a}if(this.x+=n*this.moveSpeed*e,this.y+=r*this.moveSpeed*e,this.x=Math.max(this.size,Math.min(window.innerWidth-this.size,this.x)),this.y=Math.max(this.size,Math.min(window.innerHeight-this.size,this.y)),this.attackTimer-=e,this.attackTimer<=0&&t&&t.length>0){const a=this.findNearestEnemy(t);if(a){const h=a.x-this.x,o=a.y-this.y;if(Math.sqrt(h*h+o*o)<=this.pStats.detection){for(let d=0;d<this.pStats.count;d++)i(this.x,this.y,a.x,a.y,this.pStats,d,this.pStats.count);this.attackTimer=this.pStats.cooldown}}}}findNearestEnemy(e){let s=null,t=1/0;for(const i of e){const n=i.x-this.x,r=i.y-this.y,a=n*n+r*r;a<t&&(t=a,s=i)}return s}draw(e){e.drawCircle(this.x,this.y,this.size,this.color);const s=Math.max(0,this.hp/this.maxHp);e.drawRect(this.x,this.y-25,40,6,"#333"),e.drawRect(this.x-20+20*s,this.y-25,40*s,6,"#e74c3c")}gainExp(e,s){this.exp+=e,this.exp>=this.nextLevelExp&&this.levelUp(s)}levelUp(e){this.level++,this.points++,this.exp-=this.nextLevelExp,this.nextLevelExp=Math.floor(this.nextLevelExp*1.2),this.hp=this.maxHp,console.log(`Level Up! Now level ${this.level}. Points: ${this.points}`),e&&e()}}class y extends f{constructor(e,s,t,i,n,r,a,h){super(e,s,i,n,r),this.player=t,this.hp=a,this.expValue=h}update(e){const s=this.player.x-this.x,t=this.player.y-this.y,i=Math.sqrt(s*s+t*t);i>0&&(this.x+=s/i*this.speed*e,this.y+=t/i*this.speed*e)}draw(e){e.drawRect(this.x,this.y,this.size*2,this.size*2,this.color)}}class g extends y{constructor(e,s,t){super(e,s,t,12,"#e74c3c",100,10,10)}}class M extends y{constructor(e,s,t){super(e,s,t,20,"#8e44ad",50,40,30)}}class L extends y{constructor(e,s,t){super(e,s,t,8,"#e67e22",250,5,15)}}class S extends y{constructor(e,s,t){super(e,s,t,12,"#1abc9c",120,15,20),this.angleOffset=0,this.time=Math.random()*100}update(e){this.time+=e;const s=this.player.x-this.x,t=this.player.y-this.y;if(Math.sqrt(s*s+t*t)>0){const n=Math.atan2(t,s)+Math.sin(this.time*5)*.5;this.x+=Math.cos(n)*this.speed*e,this.y+=Math.sin(n)*this.speed*e}}}class k extends y{constructor(e,s,t){super(e,s,t,15,"#95a5a6",80,20,15);const i=window.innerWidth/2,n=window.innerHeight/2,r=i-e,a=n-s,h=Math.sqrt(r*r+a*a);this.vx=r/h*this.speed,this.vy=a/h*this.speed}update(e){this.x+=this.vx*e,this.y+=this.vy*e}}class C{constructor(){this.renderer=new x("gameCanvas"),this.player=new w(window.innerWidth/2,window.innerHeight/2),this.enemies=[],this.projectiles=[],this.gems=[],this.lastTime=0,this.input={keys:{}},this.score=0,this.isGameOver=!1,this.isLevelingUp=!1,this.spawnTimer=0,this.spawnInterval=1,this.spawnWeights={Chaser:100,Tank:0,Rusher:0,Erratic:0,Drifter:0},this.enemyTypes={Chaser:g,Tank:M,Rusher:L,Erratic:S,Drifter:k},this.setupInput(),this.loop=this.loop.bind(this),requestAnimationFrame(this.loop)}setupInput(){window.addEventListener("keydown",e=>this.input.keys[e.key]=!0),window.addEventListener("keyup",e=>this.input.keys[e.key]=!1),document.getElementById("restart-btn").addEventListener("click",()=>this.restart())}restart(){console.log("Restarting game..."),this.player=new w(window.innerWidth/2,window.innerHeight/2),this.enemies=[],this.projectiles=[],this.gems=[],this.score=0,this.isGameOver=!1,this.isLevelingUp=!1,this.spawnWeights={Chaser:100,Tank:0,Rusher:0,Erratic:0,Drifter:0};const e=document.getElementById("game-over");e?e.classList.add("hidden"):console.error("Game Over element not found!"),this.lastTime=performance.now(),requestAnimationFrame(this.loop)}spawnEnemy(){const e=Object.values(this.spawnWeights).reduce((r,a)=>r+a,0);let s=Math.random()*e,t=g;for(const[r,a]of Object.entries(this.spawnWeights))if(s-=a,s<=0){t=this.enemyTypes[r];break}let i,n;Math.random()<.5?(i=Math.random()<.5?-50:window.innerWidth+50,n=Math.random()*window.innerHeight):(i=Math.random()*window.innerWidth,n=Math.random()<.5?-50:window.innerHeight+50),this.enemies.push(new t(i,n,this.player))}update(e){if(!(this.isGameOver||this.isLevelingUp)){this.player.update(e,this.input,this.enemies,(s,t,i,n,r,a,h)=>{let o=Math.atan2(n-t,i-s);if(h>1){const m=r.spread;o=o-m*(h-1)/2+m*a,i=s+Math.cos(o)*100,n=t+Math.sin(o)*100}this.projectiles.push(new v(s,t,i,n,r))}),this.projectiles.forEach(s=>s.update(e)),this.projectiles=this.projectiles.filter(s=>!s.isDead),this.spawnTimer+=e,this.spawnTimer>=this.spawnInterval&&(this.spawnEnemy(),this.spawnTimer=0,this.spawnInterval>.2&&(this.spawnInterval-=.01)),this.enemies.forEach(s=>s.update(e)),this.gems.forEach(s=>s.update(e));for(const s of this.projectiles)for(const t of this.enemies){if(t.isDead||s.hitEnemies.includes(t))continue;const i=s.x-t.x,n=s.y-t.y;if(Math.sqrt(i*i+n*n)<s.size+t.size&&(t.hp-=s.damage,s.hitEnemies.push(t),s.hitEnemies.length>s.pierce&&(s.isDead=!0),t.hp<=0&&(t.isDead=!0,this.score+=10,this.gems.push(new E(t.x,t.y,t.expValue))),s.isDead))break}for(const s of this.enemies){if(s.isDead)continue;const t=this.player.x-s.x,i=this.player.y-s.y;Math.sqrt(t*t+i*i)<this.player.size+s.size&&(this.player.hp-=10,s.isDead=!0,this.player.hp<=0&&this.gameOver())}for(const s of this.gems){const t=this.player.x-s.x,i=this.player.y-s.y;Math.sqrt(t*t+i*i)<this.player.size+s.size+this.player.magnet&&(s.isDead=!0,this.player.gainExp(s.value,()=>this.triggerLevelUp()))}this.gems=this.gems.filter(s=>!s.isDead),this.enemies=this.enemies.filter(s=>{if(s.isDead)return!1;const t=s.x-this.player.x,i=s.y-this.player.y;return t*t+i*i<2e3*2e3}),this.updateUI()}}updateUI(){const e=document.getElementById("hp-bar"),s=document.getElementById("score"),t=Math.max(0,this.player.hp/this.player.maxHp*100);e.style.width=`${t}%`,s.textContent=`スコア: ${this.score} | レベル: ${this.player.level} | Pt: ${this.player.points}`}triggerLevelUp(){this.isLevelingUp=!0;const e=document.getElementById("upgrade-modal"),s=document.getElementById("upgrade-options");s.innerHTML="",e.classList.remove("hidden");const t=e.querySelector("h2");t.innerText=`ショップ - 所持ポイント: ${this.player.points}`;const i=this.getAllUpgrades(),n=i.filter(o=>!o.type.startsWith("enemy_")),r=i.filter(o=>o.type.startsWith("enemy_")),a=(o,m)=>{const d=document.createElement("div");d.className="shop-section",d.innerHTML=`<h3>${o}</h3>`;const u=document.createElement("div");return u.className="upgrade-grid",m.forEach(p=>{const l=document.createElement("div");l.className="upgrade-card shop-card",this.player.points<p.cost&&l.classList.add("disabled"),p.type.startsWith("enemy_")&&(l.style.borderColor=p.cost===0?"#2ecc71":"#e74c3c"),l.innerHTML=`
                    <h4>${p.name}</h4>
                    <p>${p.description}</p>
                    <div class="cost">${p.cost>0?p.cost+" Pt":"無料"}</div>
                `,l.onclick=()=>{this.player.points>=p.cost&&(this.player.points-=p.cost,this.applyUpgrade(p),this.triggerLevelUp())},u.appendChild(l)}),d.appendChild(u),d};s.appendChild(a("プレイヤー強化",n)),s.appendChild(a("敵出現管理",r));let h=e.querySelector(".skip-btn");h||(h=document.createElement("button"),h.className="skip-btn",h.innerText="閉じる / スキップ",h.onclick=()=>{e.classList.add("hidden"),this.isLevelingUp=!1,this.lastTime=performance.now(),requestAnimationFrame(this.loop)},e.appendChild(h))}getAllUpgrades(){const e=[{type:"size",name:"巨大弾",description:"サイズ +50%",cost:1,apply:t=>t.pStats.size*=1.5},{type:"speed",name:"高速弾",description:"弾速 +20%",cost:1,apply:t=>t.pStats.speed*=1.2},{type:"damage",name:"パワーアップ",description:"ダメージ +5",cost:1,apply:t=>t.pStats.damage+=5},{type:"count",name:"マルチショット",description:"発射数 +1",cost:3,apply:t=>t.pStats.count+=1},{type:"pierce",name:"ドリル",description:"貫通数 +1",cost:2,apply:t=>t.pStats.pierce+=1},{type:"cooldown",name:"連射",description:"連射速度 +15%",cost:1,apply:t=>t.pStats.cooldown*=.85},{type:"magnet",name:"マグネット",description:"取得範囲 +50",cost:1,apply:t=>t.magnet+=50},{type:"range",name:"スナイパー",description:"射程 +100",cost:1,apply:t=>t.pStats.range+=100},{type:"detection",name:"レーダー",description:"索敵範囲 +100",cost:1,apply:t=>t.pStats.detection+=100},{type:"moveSpeed",name:"俊足",description:"移動速度 +20",cost:1,apply:t=>t.moveSpeed+=20},{type:"spread_up",name:"ワイド",description:"拡散 +10°",cost:1,apply:t=>t.pStats.spread+=.17},{type:"spread_down",name:"フォーカス",description:"拡散 -10°",cost:1,apply:t=>t.pStats.spread=Math.max(0,t.pStats.spread-.17)}];return["Tank","Rusher","Erratic","Drifter"].forEach(t=>{e.push({type:`enemy_add_${t}`,name:`${t} 追加`,description:"出現率 +20 (無料)",cost:0,apply:()=>this.spawnWeights[t]+=20}),this.spawnWeights[t]>0&&e.push({type:`enemy_remove_${t}`,name:`${t} 削減`,description:"出現率 -20 (1 Pt)",cost:1,apply:()=>this.spawnWeights[t]=Math.max(0,this.spawnWeights[t]-20)})}),e.push({type:"enemy_add_Chaser",name:"Chaser 追加",description:"出現率 +20 (無料)",cost:0,apply:()=>this.spawnWeights.Chaser+=20}),this.spawnWeights.Chaser>0&&e.push({type:"enemy_remove_Chaser",name:"Chaser 削減",description:"出現率 -20 (1 Pt)",cost:1,apply:()=>this.spawnWeights.Chaser=Math.max(0,this.spawnWeights.Chaser-20)}),e}applyUpgrade(e){e.type.startsWith("enemy_")?e.apply():e.apply(this.player),console.log(`Applied upgrade: ${e.name}`)}draw(){this.renderer.clear(),this.gems.forEach(e=>e.draw(this.renderer)),this.projectiles.forEach(e=>e.draw(this.renderer)),this.enemies.forEach(e=>e.draw(this.renderer)),this.player.draw(this.renderer)}gameOver(){console.log("Game Over!"),this.isGameOver=!0,document.getElementById("game-over").classList.remove("hidden")}loop(e){if(this.isGameOver&&this.input.keys.r,this.isLevelingUp)return;const s=(e-this.lastTime)/1e3;this.lastTime=e,this.isGameOver||(this.update(s),this.draw(),requestAnimationFrame(this.loop))}}window.addEventListener("DOMContentLoaded",()=>{new C});
